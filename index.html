<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generator listy obecno≈õci</title>
  <style>
    :root {
      --bg:#f7f7fb; --ink:#111; --line:#e5e7eb; --brand:#0ea5e9; --ok:#16a34a; --danger:#ef4444; --weekend:#fde68a;
    }
    body { margin:0; font-family:system-ui,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--ink); }
    .wrap { max-width:900px; margin:24px auto; padding:0 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .toolbar .spacer { flex:1; }
    .btn { padding:6px 10px; border:1px solid var(--line); border-radius:8px; cursor:pointer; font-size:13px; }
    .btn.primary { background:var(--brand); border-color:var(--brand); color:#fff; }
    .btn.ok { background:var(--ok); border-color:var(--ok); color:#fff; }
    table { width:100%; border-collapse:collapse; margin-bottom:16px; }
    th, td { border:1px solid var(--line); padding:4px 6px; font-size:12px; text-align:center; }
    th { background:#fafafa; }
    .mark-weekend { background:var(--weekend); }
    #reportHeader { text-align:center; padding:10px 0; font-size:15px; font-weight:600 }
    @media print { .no-print { display:none!important } }
    @page { size:A4 portrait; margin:10mm }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="toolbar no-print">
    <h1 style="margin:0;font-size:20px">‚úÖ Generator listy obecno≈õci</h1>
    <div class="spacer"></div>
    <button class="btn primary" id="btnPdf">Eksportuj do PDF</button>
    <button class="btn ok" id="btnExcel">Eksportuj do Excela</button>
  </div>

  <div class="card">
    <div class="controls no-print" style="margin-bottom:10px;">
      <label>Firma: <input type="text" id="company"></label>
      <label>Kierowca: <input type="text" id="driver"></label>
      <label>Rok: <input type="number" id="year"></label>
      <label>MiesiƒÖc:
        <select id="month">
          <option value="0">Stycze≈Ñ</option><option value="1">Luty</option><option value="2">Marzec</option>
          <option value="3">Kwiecie≈Ñ</option><option value="4">Maj</option><option value="5">Czerwiec</option>
          <option value="6">Lipiec</option><option value="7">Sierpie≈Ñ</option><option value="8">Wrzesie≈Ñ</option>
          <option value="9">Pa≈∫dziernik</option><option value="10">Listopad</option><option value="11">Grudzie≈Ñ</option>
        </select>
      </label>
    </div>

    <div id="reportHeader"></div>

    <div id="tableWrapper"></div>
    <div id="summary" style="padding:10px;font-size:13px"></div>

    <div id="kmSection" style="padding:10px;font-size:13px">
      <h3>üöó Kilometry</h3>
      <div class="km-edit no-print">
        <label>Stan licznika poczƒÖtek miesiƒÖca: <input type="number" id="kmStart"></label>
        <label>Stan licznika koniec miesiƒÖca: <input type="number" id="kmEnd"></label>
      </div>
      <table style="width:100%;border-collapse:collapse;margin-top:10px">
        <thead><tr>
          <th>Stan poczƒÖtek</th><th>Stan koniec</th><th>Przebyty dystans</th>
        </tr></thead>
        <tbody><tr>
          <td id="kmCellStart">0 km</td><td id="kmCellEnd">0 km</td><td id="kmCellDiff">0 km</td>
        </tr></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const PL_DAYS=['Nd','Pn','Wt','≈ör','Cz','Pt','So'];
const PL_MONTHS=['stycze≈Ñ','luty','marzec','kwiecie≈Ñ','maj','czerwiec','lipiec','sierpie≈Ñ','wrzesie≈Ñ','pa≈∫dziernik','listopad','grudzie≈Ñ'];

const state={year:new Date().getFullYear(),month:new Date().getMonth(),driver:'',attendance:{},hours:{},kmStart:0,kmEnd:0};
const elYear=document.getElementById('year');
const elMonth=document.getElementById('month');
const elDriver=document.getElementById('driver');
const wrapper=document.getElementById('tableWrapper');
const summaryEl=document.getElementById('summary');
const kmStart=document.getElementById('kmStart');
const kmEnd=document.getElementById('kmEnd');
const kmCellStart=document.getElementById('kmCellStart');
const kmCellEnd=document.getElementById('kmCellEnd');
const kmCellDiff=document.getElementById('kmCellDiff');
const reportHeader=document.getElementById('reportHeader');

function daysInMonth(m,y){return new Date(y,m+1,0).getDate();}
function isWeekend(y,m,d){let wd=new Date(y,m,d).getDay();return wd===0||wd===6;}

function buildTable(){
  const dim=daysInMonth(state.month,state.year);
  let html='<table><thead><tr><th>Dzie≈Ñ</th><th>Status</th><th>Start</th><th>Koniec</th></tr></thead><tbody>';
  let totalOk=0,totalX=0,totalU=0,totalW=0,totalSob=0,totalNd=0;
  for(let d=1;d<=dim;d++){
    let wd=new Date(state.year,state.month,d).getDay();
    let val=state.attendance[d]|| (isWeekend(state.year,state.month,d)?'W':'');
    if(val==='‚úî') totalOk++;
    if(val==='x') totalX++;
    if(val==='U') totalU++;
    if(val==='W'){ totalW++; if(wd===6) totalSob++; if(wd===0) totalNd++; }
    let h=state.hours[d]||{start:'',end:''};
    html+=`<tr class="${val==='W'?'mark-weekend':''}">
      <td>${d} ${PL_DAYS[wd]}</td>
      <td>
        <select data-d="${d}" class="statusSel">
          <option value="" ${val===''?'selected':''}></option>
          <option value="‚úî" ${val==='‚úî'?'selected':''}>‚úî</option>
          <option value="x" ${val==='x'?'selected':''}>x</option>
          <option value="U" ${val==='U'?'selected':''}>U</option>
          <option value="W" ${val==='W'?'selected':''}>W</option>
        </select>
      </td>
      <td><input type="time" value="${h.start}" data-d="${d}" data-type="start"></td>
      <td><input type="time" value="${h.end}" data-d="${d}" data-type="end"></td>
    </tr>`;
  }
  html+='</tbody></table>';
  wrapper.innerHTML=html;
  wrapper.querySelectorAll('.statusSel').forEach(sel=>sel.addEventListener('change',e=>{
    const d=e.target.dataset.d; state.attendance[d]=e.target.value; buildTable();
  }));
  wrapper.querySelectorAll('input[type="time"]').forEach(inp=>inp.addEventListener('change',e=>{
    const d=e.target.dataset.d; const type=e.target.dataset.type;
    if(!state.hours[d]) state.hours[d]={start:'',end:''};
    state.hours[d][type]=e.target.value;
  }));
  summaryEl.innerHTML=`‚úî Obecno≈õci: ${totalOk}, x Wolne: ${totalX}, U Urlopy: ${totalU}, W Weekendy: ${totalW} (Soboty:${totalSob}, Niedziele:${totalNd})`;
  updateHeader();
  updateKmSummary();
}

function updateHeader(){ reportHeader.innerHTML=`Lista obecno≈õci ‚Äì ${PL_MONTHS[state.month]} ${state.year}<br>Kierowca: ${state.driver}`; }
function updateKmSummary(){
  state.kmStart=parseInt(kmStart.value||0,10); state.kmEnd=parseInt(kmEnd.value||0,10);
  const traveled=state.kmEnd-state.kmStart;
  kmCellStart.textContent=`${state.kmStart} km`; kmCellEnd.textContent=`${state.kmEnd} km`;
  kmCellDiff.textContent= traveled>=0?`${traveled} km`:'';
}

document.getElementById('btnPdf').addEventListener('click',()=>window.print());

document.getElementById('btnExcel').addEventListener('click',()=>{
  const days=daysInMonth(state.month,state.year);
  let obecnosci=[["Dzie≈Ñ","Nazwa dnia","Status","Start","Koniec"]];
  for(let d=1;d<=days;d++){
    const wd=new Date(state.year,state.month,d).getDay();
    const nazwaDnia=PL_DAYS[wd];
    const val=state.attendance[d]||''; const h=state.hours[d]||{start:'',end:''};
    obecnosci.push([d,nazwaDnia,val,h.start,h.end]);
  }
  let podsumowanie=[]; 
  summaryEl.textContent.split(',').forEach(s=>{podsumowanie.push([s.trim()])});
  const traveled=state.kmEnd-state.kmStart;
  let kilometry=[["Stan poczƒÖtek","Stan koniec","Przebyty dystans"],[state.kmStart,state.kmEnd,traveled>=0?traveled:""]];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(obecnosci),"Obecno≈õƒá");
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(podsumowanie),"Podsumowanie");
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(kilometry),"Kilometry");
  XLSX.writeFile(wb,`Lista_obecnosci_${state.year}_${state.month+1}.xlsx`);
});

elYear.addEventListener('input',()=>{state.year=parseInt(elYear.value,10)||new Date().getFullYear(); buildTable();});
elMonth.addEventListener('input',()=>{state.month=parseInt(elMonth.value,10); buildTable();});
elDriver.addEventListener('input',()=>{state.driver=elDriver.value; updateHeader();});
kmStart.addEventListener('input',updateKmSummary);
kmEnd.addEventListener('input',updateKmSummary);

(function start(){elYear.value=state.year;elMonth.value=state.month;buildTable();})();
</script>
</body>
</html>
