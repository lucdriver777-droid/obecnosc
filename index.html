<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generator listy obecności</title>
  <style>
    body { margin:0; font-family:"Times New Roman", Times, serif; background:#f7f7fb; color:#111; }
    .wrap { max-width:900px; margin:24px auto; padding:0 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .toolbar .spacer { flex:1; }
    .btn { padding:6px 10px; border:1px solid #ccc; border-radius:6px; cursor:pointer; font-size:13px; }
    .btn.primary { background:#0ea5e9; border-color:#0ea5e9; color:#fff; }
    .btn.ok { background:#16a34a; border-color:#16a34a; color:#fff; }
    table { width:100%; border-collapse:collapse; margin-bottom:12px; }
    th, td { border:1px solid #ddd; padding:4px 6px; font-size:12px; text-align:center; }
    th { background:#f0f0f0; }
    .mark-weekend { background:#fde68a; }
    #reportHeader { text-align:center; padding:8px 0; font-size:14px; font-weight:600 }
    #footer { margin-top:15px; text-align:center; font-size:11px; font-style:italic; }
    @media print {
      body { font-size:11px; }
      table th, table td { padding:2px 3px; font-size:10px; }
      .no-print { display:none!important; }
      #footer { margin-top:10px; font-size:10px; }
      @page { size:A4 portrait; margin:8mm }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="toolbar no-print">
    <h1 style="margin:0;font-size:18px">✅ Generator listy obecności</h1>
    <div class="spacer"></div>
    <button class="btn primary" id="btnPdf">Eksportuj do PDF</button>
    <button class="btn ok" id="btnExcel">Eksportuj do Excela</button>
  </div>

  <div class="controls no-print" style="margin-bottom:10px;">
    <label>Firma: <input type="text" id="company"></label>
    <label>Kierowca: <input type="text" id="driver"></label>
    <label>Auto: <input type="text" id="auto"></label>
    <label>Rok: <input type="number" id="year"></label>
    <label>Miesiąc:
      <select id="month">
        <option value="0">Styczeń</option><option value="1">Luty</option><option value="2">Marzec</option>
        <option value="3">Kwiecień</option><option value="4">Maj</option><option value="5">Czerwiec</option>
        <option value="6">Lipiec</option><option value="7">Sierpień</option><option value="8">Wrzesień</option>
        <option value="9">Październik</option><option value="10">Listopad</option><option value="11">Grudzień</option>
      </select>
    </label>
  </div>

  <div id="reportHeader"></div>
  <div id="tableWrapper"></div>
  <div id="footer">Twórcy: Łukasz Stasinski &amp; ChatGPT</div>
</div>

<script>
const PL_DAYS=['Nd','Pn','Wt','Śr','Cz','Pt','So'];
const PL_MONTHS=['styczeń','luty','marzec','kwiecień','maj','czerwiec','lipiec','sierpień','wrzesień','październik','listopad','grudzień'];

const state={year:new Date().getFullYear(),month:new Date().getMonth(),driver:'',auto:'',attendance:{},hours:{},kmStart:0,kmEnd:0};

const elYear=document.getElementById('year');
const elMonth=document.getElementById('month');
const elDriver=document.getElementById('driver');
const elAuto=document.getElementById('auto');
const wrapper=document.getElementById('tableWrapper');
const reportHeader=document.getElementById('reportHeader');

function daysInMonth(m,y){return new Date(y,m+1,0).getDate();}
function isWeekend(y,m,d){let wd=new Date(y,m,d).getDay();return wd===0||wd===6;}

function buildTable(){
  const dim=daysInMonth(state.month,state.year);
  let html='<table><thead><tr><th>Dzień</th><th>Status</th><th>Start</th><th>Koniec</th></tr></thead><tbody>';
  let totalOk=0,totalX=0,totalU=0,totalW=0,totalSob=0,totalNd=0;
  for(let d=1;d<=dim;d++){
    let wd=new Date(state.year,state.month,d).getDay();
    let val=state.attendance[d]|| (isWeekend(state.year,state.month,d)?'W':'');
    if(val==='✔') totalOk++;
    if(val==='x') totalX++;
    if(val==='U') totalU++;
    if(val==='W'){ totalW++; if(wd===6) totalSob++; if(wd===0) totalNd++; }
    let h=state.hours[d]||{start:'',end:''};

    html+=`<tr class="${val==='W'?'mark-weekend':''}">
      <td>${d} ${PL_DAYS[wd]}</td>
      <td>
        <select data-d="${d}" class="statusSel">
          <option value="" ${val===''?'selected':''}></option>
          <option value="✔" ${val==='✔'?'selected':''}>✔</option>
          <option value="x" ${val==='x'?'selected':''}>x</option>
          <option value="U" ${val==='U'?'selected':''}>U</option>
          <option value="W" ${val==='W'?'selected':''}>W</option>
        </select>
      </td>
      <td><input type="time" value="${h.start}" data-d="${d}" data-type="start"></td>
      <td><input type="time" value="${h.end}" data-d="${d}" data-type="end"></td>
    </tr>`;
  }

  // podsumowanie
  html+=`<tr><td colspan="4">✔ Obecności: ${totalOk} | x Wolne: ${totalX} | U Urlopy: ${totalU} | W Weekendy: ${totalW} (S:${totalSob}, N:${totalNd})</td></tr>`;
  const traveled=state.kmEnd-state.kmStart;
  html+=`<tr><td>Stan początek: <input type="number" id="kmStart" value="${state.kmStart}" style="width:80px"></td>
             <td>Stan koniec: <input type="number" id="kmEnd" value="${state.kmEnd}" style="width:80px"></td>
             <td colspan="2">Przebyty dystans: ${traveled>=0?traveled:''} km</td></tr>`;

  html+='</tbody></table>';
  wrapper.innerHTML=html;

  wrapper.querySelectorAll('.statusSel').forEach(sel=>sel.addEventListener('change',e=>{
    const d=e.target.dataset.d; state.attendance[d]=e.target.value; buildTable();
  }));
  wrapper.querySelectorAll('input[type="time"]').forEach(inp=>inp.addEventListener('change',e=>{
    const d=e.target.dataset.d; const type=e.target.dataset.type;
    if(!state.hours[d]) state.hours[d]={start:'',end:''};
    state.hours[d][type]=e.target.value;
  }));
  const kmStart=document.getElementById('kmStart');
  const kmEnd=document.getElementById('kmEnd');
  if(kmStart) kmStart.addEventListener('input',e=>{
    state.kmStart=parseInt(e.target.value)||0;
    buildTable();
  });
  if(kmEnd) kmEnd.addEventListener('input',e=>{
    state.kmEnd=parseInt(e.target.value)||0;
    buildTable();
  });
  updateHeader();
}

function updateHeader(){
  reportHeader.innerHTML =
    `Firma: ${document.getElementById('company').value || ''}<br>` +
    `Kierowca: ${state.driver} | Auto: ${state.auto}<br>` +
    `Lista obecności – ${PL_MONTHS[state.month]} ${state.year}`;
}

// PDF
document.getElementById('btnPdf').addEventListener('click',()=>window.print());

// Excel
document.getElementById('btnExcel').addEventListener('click',()=>{
  const days=daysInMonth(state.month,state.year);
  let obecnosci=[["Dzień","Nazwa dnia","Status","Start","Koniec"]];
  for(let d=1;d<=days;d++){
    const wd=new Date(state.year,state.month,d).getDay();
    const nazwaDnia=PL_DAYS[wd];
    const val=state.attendance[d]||''; const h=state.hours[d]||{start:'',end:''};
    obecnosci.push([d,nazwaDnia,val,h.start,h.end]);
  }
  let podsumowanie=[["✔ Obecności","x Wolne","U Urlopy","W Weekendy (Sob/Nd)"],
                    [obecnosci.filter(r=>r[2]==='✔').length,
                     obecnosci.filter(r=>r[2]==='x').length,
                     obecnosci.filter(r=>r[2]==='U').length,
                     obecnosci.filter(r=>r[2]==='W').length]];
  let kilometry=[["Stan początek","Stan koniec","Przebyty dystans"],
                 [state.kmStart,state.kmEnd,state.kmEnd-state.kmStart>=0?state.kmEnd-state.kmStart:""]];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(obecnosci),"Obecność");
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(podsumowanie),"Podsumowanie");
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(kilometry),"Kilometry");
  XLSX.writeFile(wb,`Lista_obecnosci_${state.year}_${state.month+1}.xlsx`);
});

elYear.addEventListener('input',()=>{state.year=parseInt(elYear.value,10)||new Date().getFullYear(); buildTable();});
elMonth.addEventListener('input',()=>{state.month=parseInt(elMonth.value,10); buildTable();});
elDriver.addEventListener('input',()=>{state.driver=elDriver.value; updateHeader();});
elAuto.addEventListener('input',()=>{state.auto=elAuto.value; updateHeader();});

(function start(){elYear.value=state.year;elMonth.value=state.month;buildTable();})();
</script>
</body>
</html>
